version: "3"

vars:
    PROJECT_NAME: homelab
    PYTHON_VERSION: "3.9"

tasks:
    install:
        desc: Install project dependencies
        cmds:
            - poetry install --no-root
            - poetry run pre-commit install

    test:
        desc: Run unit and integration tests with coverage
        cmds:
            - echo "üß™ Running unit tests with coverage..."
            - mkdir -p coverage
            - rm -rf /tmp/bats-run-* 2>/dev/null || true
            - kcov --bash-method=DEBUG --include-pattern=scripts,stacks --exclude-pattern=/usr,/tmp,/var coverage/unit bats --jobs 1 tests/unit/scripts/**/*.bats tests/unit/scripts/*.bats stacks/apps/*/tests/*.bats
            - echo "üß™ Unit tests completed successfully"
            - echo "üìä Merging coverage reports..."
            - kcov --merge coverage/merged coverage/unit
            - echo "‚úÖ All tests completed [Coverage report](coverage/merged/index.html)"

    test-fast:
        desc: Run core tests with faster execution
        cmds:
            - echo "üß™ Running unit tests..."
            - bats --tap tests/unit/scripts/**/*.bats tests/unit/scripts/*.bats stacks/apps/*/tests/*.bats

    test-local:
        desc: Run local-only tests (requires Docker)
        cmds:
            - echo "üè† Running local-only tests..."
            - scripts/run_local_tests.sh
            - echo "‚úÖ Local tests completed"

    test-comprehensive:
        desc: Run all tests (unit/integration + local)
        deps: ["test", "test-local"]

    test-performance:
        desc: Run performance and regression tests
        cmds:
            - echo "‚ö° Running performance tests..."
            - bats tests/performance/generation_performance_test.bats
            - echo "‚úÖ Performance tests completed"

    lint:
        desc: Run all linting checks
        deps: ["lint:shell", "lint:yaml", "lint:dockerfile", "lint:secrets"]

    lint:shell:
        desc: Run shellcheck on shell scripts
        cmds:
            - poetry run shellcheck -x --source-path=scripts scripts/*.sh

    lint:yaml:
        desc: Run yamllint on YAML files
        cmds:
            - poetry run yamllint .

    lint:dockerfile:
        desc: Run hadolint on Dockerfiles (using pre-commit)
        cmds:
            - poetry run pre-commit run hadolint --all-files

    lint:secrets:
        desc: Run gitleaks to check for secrets (via pre-commit)
        cmds:
            - poetry run pre-commit run gitleaks --all-files

    lint:python:
        desc: Run pre-commit hooks (includes Python linting)
        cmds:
            - poetry run pre-commit run --all-files

    static-analysis:
        desc: Run static analysis tools
        deps: [lint, "security-scan"]

    security-scan:
        desc: Run security scanning (via pre-commit)
        cmds:
            - poetry run pre-commit run gitleaks --all-files

    format:
        desc: Format code
        cmds:
            - poetry run pre-commit run --all-files

    clean:
        desc: Clean up generated files and caches
        cmds:
            - rm -rf .pytest_cache
            - rm -rf __pycache__
            - find . -name "*.pyc" -delete
            - find . -name ".bats-*" -delete

    docs:build:
        desc: Build documentation with MkDocs
        cmds:
            - poetry run mkdocs build --clean --strict
        env:
            MKDOCS_ENABLE_SOCIAL: false

    docs:serve:
        desc: Serve documentation locally with live reload
        cmds:
            - poetry run mkdocs serve --dev-addr=0.0.0.0:8000

    docs:validate:
        desc: Validate documentation build and check for issues
        cmds:
            - poetry run mkdocs build --clean
            - echo "‚úÖ Documentation builds successfully"
        env:
            MKDOCS_ENABLE_SOCIAL: false

    docs:validate-strict:
        desc: Validate documentation build with strict mode (fails on warnings)
        cmds:
            - poetry run mkdocs build --clean --strict
            - echo "‚úÖ Documentation builds successfully with no warnings"
        env:
            MKDOCS_ENABLE_SOCIAL: false

    check:
        desc: Run all checks (lint, test, static analysis, docs)
        deps: [lint, test, "static-analysis", "docs:validate"]

    release:version:
        desc: Check what the next version would be
        cmds:
            - poetry run semantic-release version --print

    release:
        desc: Run semantic release (determines if release needed and executes)
        cmds:
            - git config --global user.name "github-actions[bot]"
            - git config --global user.email "github-actions[bot]@users.noreply.github.com"
            - poetry run semantic-release version --skip-build

    release:update-lock:
        desc: Update Poetry lock file after release
        cmds:
            - poetry lock --no-update
            - |
                if [ -n "$(git diff --name-only)" ]; then
                  git add poetry.lock
                  git commit -m "chore: update poetry.lock after release"
                  echo "Poetry lock file updated and committed"
                else
                  echo "Poetry lock file is already up to date"
                fi

    help:
        desc: Show available tasks
        cmds:
            - task --list
