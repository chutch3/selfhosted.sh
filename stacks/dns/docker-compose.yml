services:
    dns-server:
        image: technitium/dns-server:14.0.1
        hostname: "dns-server"
        ports:
            # Ingress mode - accessible via any swarm node through routing mesh
            - "53:53/udp"
            - "53:53/tcp"
            - "5380:5380"
        deploy:
            replicas: 1
            placement:
                constraints:
                    # Runs on any node with dns=true label
                    # If node fails, Swarm reschedules to another labeled node
                    - node.labels.dns == true
            labels:
                - traefik.enable=true
                - traefik.http.routers.dns.rule=Host(`dns.${BASE_DOMAIN}`)
                - traefik.http.routers.dns.tls=true
                - traefik.http.routers.dns.tls.certresolver=dns
                - traefik.http.services.dns.loadbalancer.server.port=5380

                - homepage.group=Infrastructure
                - homepage.name=DNS
                - homepage.icon=technitium-dns.png
                - homepage.href=https://dns.${BASE_DOMAIN}/
                - homepage.description=DNS Server (Swarm failover enabled)
        environment:
            - DNS_SERVER_DOMAIN=dns.${BASE_DOMAIN}
            - DNS_SERVER_ADMIN_PASSWORD=${DNS_ADMIN_PASSWORD:-admin}
            - DNS_SERVER_PREFER_IPV6=false
            - DNS_SERVER_WEB_SERVICE_LOCAL_ADDRESSES=0.0.0.0
            - DNS_SERVER_RECURSION=AllowOnlyForPrivateNetworks
            - DNS_SERVER_ENABLE_BLOCKING=true
            - DNS_SERVER_FORWARDERS=${DNS_SERVER_FORWARDERS}
            - DNS_SERVER_LOG_QUERIES=false
            - DNS_SERVER_WEB_SERVICE_HTTP_PORT=5380
            - ASPNETCORE_HTTP_PORTS=5380
        volumes:
            # CIFS volume ensures data persists across node failover
            - dns-config:/etc/dns
        sysctls:
            - net.ipv4.ip_local_port_range=1024 65000
        networks:
            - traefik-public

volumes:
    dns-config:
        driver: local
        driver_opts:
            type: "cifs"
            o: "username=${SMB_USERNAME},password=${SMB_PASSWORD},vers=3.0,nobrl,uid=0,gid=100,file_mode=0777,dir_mode=0777,soft,actimeo=30"
            device: "//${NAS_SERVER}/dns"

networks:
    traefik-public:
        external: true
