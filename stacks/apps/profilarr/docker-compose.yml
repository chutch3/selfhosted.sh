version: "3.9"

services:
    # 1. THE MAIN APPLICATION (Requires 1 replica for SQLite)
    profilarr:
        image: santiagosayshey/profilarr:latest
        environment:
            - PUID=1000
            - PGID=1000
            - TZ=${TZ}
        volumes:
            - profilarr_local_data:/config
        networks:
            - traefik-public
        deploy:
            mode: replicated
            replicas: 1
            restart_policy:
                condition: any
            labels:
                - "traefik.enable=true"
                - "traefik.http.routers.profilarr.rule=Host(`profilarr.${BASE_DOMAIN}`)"
                - "traefik.http.routers.profilarr.entrypoints=websecure"
                - "traefik.http.routers.profilarr.tls.certresolver=dns"
                - "traefik.http.services.profilarr.loadbalancer.server.port=6868"
                # Homepage labels
                - "homepage.group=Downloads"
                - "homepage.name=Profilarr"
                - "homepage.icon=profilarr.png"
                - "homepage.href=https://profilarr.${BASE_DOMAIN}/"
                - "homepage.description=Profile Management for Arr Services"
                - "homepage.widget.type=profilarr"
                - "homepage.widget.url=https://profilarr.${BASE_DOMAIN}/"
                - "homepage.widget.key=${PROFILARR_API_KEY}"

    # 2. THE BACKUP SIDECAR
    profilarr-backup:
        image: alpine:latest
        # depends_on is largely ignored in Swarm
        environment:
            - TZ=${TZ}
        volumes:
            - profilarr_local_data:/source:ro
            - profilarr_nas_backup:/dest
            - ./backup.sh:/backup.sh:ro
        command: ["/bin/sh", "/backup.sh"]
        deploy:
            mode: replicated
            replicas: 1
            restart_policy:
                condition: any

networks:
    traefik-public:
        external: true

volumes:
    profilarr_local_data:
    profilarr_nas_backup:
        driver: local
        driver_opts:
            type: "cifs"
            o: "username=${SMB_USERNAME},password=${SMB_PASSWORD},vers=3.0,uid=1000,gid=1000,file_mode=0777,dir_mode=0777"
            device: "//${NAS_SERVER}/profilarr"
